<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>çƒ­é—¹çš„ä¹å›­ - åœ¨çº¿æœ—è¯»ä½œä¸š</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    :root{
      --bg:#fff8ff;
      --card:#fff;
      --accent:#ff9fc4;
      --accent2:#ffd6a5;
      --text:#333;
      --muted:#7a6b7a;
      --shadow: 0 8px 24px rgba(122,107,122,0.12);
    }
    /* âœ… ä¿®å¤äº†èƒŒæ™¯å›¾ç‰‡é“¾æ¥å¤šä½™çš„ https: */
    html,body{height:100%;margin:0;font-family:"PingFang SC","Microsoft YaHei","Noto Sans CJK SC",sans-serif;background:url('https://m.gettywallpapers.com/wp-content/uploads/2023/12/Cute-Desktop-Wallpaper.jpg') center/cover no-repeat fixed;color:var(--text)}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px;}
    
    /* æ ¸å¿ƒå¡ç‰‡æ ·å¼ */
    .card{width:900px;max-width:95%;background:var(--card);border-radius:24px;padding:36px;box-shadow:var(--shadow);display:flex;gap:30px;align-items:flex-start; transition: all 0.3s ease;}
    
    /* ç™»å½•å’ŒæˆåŠŸé¡µé¢çš„ç‰¹æ®Šæ ·å¼ */
    .card.center-layout { flex-direction: column; align-items: center; text-align: center; max-width: 600px;}

    .left{flex:1; width: 100%;}
    .cute-head{display:flex;align-items:center;gap:18px; margin-bottom: 20px;}
    .center-layout .cute-head { flex-direction: column; gap: 10px; text-align: center;}

    .avatar{width:78px;height:78px;border-radius:18px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:34px;box-shadow:0 6px 18px rgba(255,159,196,0.25); flex-shrink: 0;}
    h1{margin:0;font-size:24px; color: #4a3b4a;}
    p.subtitle{margin:6px 0 0;color:var(--muted); font-size: 15px;}

    .sentence-box{background:linear-gradient(180deg,#ffffff,#fffaf6);border-radius:20px;padding:30px 20px;display:flex;align-items:center;justify-content:center;min-height:200px; border: 2px solid #fff0f5;}
    
    /* å­—ä½“ä¿æŒå¤§å· */
    .sentence{font-size:40px;line-height:1.5;text-align:center;letter-spacing:2px; color: #444; font-weight: bold;}
    .sentence .ch{transition: color 150ms ease, transform 150ms ease; display: inline-block;}
    
    .controls{display:flex;gap:15px;align-items:center;justify-content:center;margin-top:24px; flex-wrap: wrap;}
    button{padding:12px 24px;border-radius:50px;border:none;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,0.06); font-size: 16px; transition: transform 0.2s;}
    button:active { transform: scale(0.98); }
    .btn-primary{background:linear-gradient(90deg,var(--accent),#ffd6a5);color:#7a2e4a;}
    .btn-ghost{background:transparent;border:2px solid #ffd6a5;color:var(--accent);}
    .btn-small-ghost{ padding: 8px 16px; font-size: 13px; background: #fff; border: 1px solid #eee; color: var(--muted);}

    .side{width:260px; flex-shrink: 0;}
    .meta{background:#fff9fc;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(122,107,122,0.05); border: 1px solid #ffe4ed;}
    .meta-item { margin-bottom: 12px; }
    .meta-label { display: block; font-size: 12px; color: var(--accent); font-weight: bold; margin-bottom: 4px;}
    .meta-value { font-size: 16px; color: var(--text); font-weight: bold;}

    .footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center;}

    .view-section { display: none; animation: fadeIn 0.4s ease; }
    .view-section.active { display: flex; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(15px); } to { opacity:1; transform: translateY(0); } }

    .form-group { margin-bottom: 20px; text-align: left; width: 100%; max-width: 320px; }
    select { width: 100%; padding: 12px; border: 2px solid #ffe4ed; border-radius: 12px; font-size: 16px; outline: none; background: #fff;}
    .google-btn-wrapper { width: 100%; display: flex; justify-content: center; margin: 20px 0; min-height: 50px;}
    .user-card { display: none; background: #f0fff4; border: 1px solid #c6f6d5; padding: 8px 16px; border-radius: 50px; align-items: center; gap: 10px; margin-bottom: 20px; }
    .user-card img { width: 28px; height: 28px; border-radius: 50%; }
    .user-card span { font-weight: bold; color: #276749; font-size: 14px; }
    .btn-large { width: 100%; max-width: 320px; font-size: 18px; padding: 14px;}
    .btn-large:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; box-shadow:none; color:#aaa; }

    @media (max-width:768px){
      .card{flex-direction:column;padding:24px; align-items: center;}
      .side{width:100%; order: 2;} 
      .left { order: 1; }
      .sentence{font-size:32px;} 
      .cute-head { justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    
    <div id="loginView" class="card center-layout view-section active">
      <div class="cute-head">
        <div class="avatar">ğŸ“–</div>
        <div>
            <h1>çƒ­é—¹çš„ä¹å›­ - è¯¾æ–‡æœ—è¯»</h1>
            <p class="subtitle">è¯·é€‰æ‹©ç­çº§å¹¶ç™»å½• Google è´¦å·</p>
        </div>
      </div>

      <div class="form-group" style="margin-top: 20px;">
        <label style="font-weight:bold;color:var(--muted);display:block;margin-bottom:8px;">é€‰æ‹©ç­çº§ (Class)</label>
        <select id="classSelect">
          <option value="" disabled selected>è¯·ç‚¹å‡»é€‰æ‹©...</option>
          <option value="2M">2M</option>
          <option value="2K">2K</option>
          <option value="2B">2B</option>
          <option value="2H">2H</option>
          <option value="2J">2J</option>
          <option value="2U">2U</option>
        </select>
      </div>

      <div id="userInfo" class="user-card">
        <img id="userImg" src="" alt="">
        <span id="userNameDisplay"></span>
      </div>

      <div class="google-btn-wrapper" id="googleBtnContainer">
        <div id="g_id_onload"
             data-client_id="1006856013626-uk3eq5tchv9t65gqosb0k6rst7hi1eeb.apps.googleusercontent.com" 
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
      </div>

      <button id="startAppBtn" class="btn-primary btn-large" disabled>è¯·å…ˆç™»å½•</button>
      
      <div class="footer">Â© åæ–‡è¯¾å®¤</div>
    </div>

    <div id="readingView" class="card view-section">
      <div class="left">
          <div class="cute-head">
            <div class="avatar" style="font-size:30px;">ğŸ”Š</div>
            <div>
                <h1>æ­£åœ¨æœ—è¯»</h1>
                <p class="subtitle">è·Ÿç€å£°éŸ³å¤§å£°è¯»å‡ºæ¥å“¦ï¼</p>
            </div>
          </div>

          <div class="sentence-box">
              <div class="sentence" id="sentenceText">åŠ è½½ä¸­...</div>
          </div>
          
          <div class="controls">
            <button id="prevBtn" class="btn-ghost">â¬… ä¸Šä¸€å¥</button>
            <button id="playBtn" class="btn-primary" style="padding: 12px 30px; font-size: 18px;">æ’­æ”¾ â–¶</button>
            <button id="nextBtn" class="btn-ghost">ä¸‹ä¸€å¥ â¡</button>
          </div>
          <div class="controls" style="margin-top: 10px;">
             <button id="autoBtn" class="btn-small-ghost">è‡ªåŠ¨æ’­æ”¾ï¼šå…³</button>
          </div>
      </div>
      
      <div class="side">
          <div class="meta">
              <div class="meta-item">
                  <span class="meta-label">ç­çº§ Class</span>
                  <span class="meta-value" id="metaClass">-</span>
              </div>
              <div class="meta-item">
                  <span class="meta-label">å§“å Name</span>
                  <span class="meta-value" id="metaName" style="font-size: 14px;">è¯·å…ˆç™»å½•</span>
              </div>
              <div class="meta-item" style="margin-top: 20px;">
                  <span class="meta-label">å½“å‰è¿›åº¦ Progress</span>
                  <span class="meta-value" style="color:var(--accent); font-size: 20px;" id="footerInfo">0 / 7</span>
              </div>
          </div>
      </div>
    </div>

    <div id="successView" class="card center-layout view-section">
      <div style="font-size:70px;margin-bottom:10px">ğŸ‰</div>
      <div class="cute-head">
        <div>
            <h1>æ­å–œä½ ï¼</h1>
            <p class="subtitle">ä½ å·²ç»å®Œæˆäº†ä»Šå¤©çš„æœ—è¯»åŠŸè¯¾ã€‚</p>
        </div>
      </div>
      
      <div style="background:#f0fff4;color:#2e7d32;padding:15px;border-radius:12px;margin:20px auto;font-size:14px; display:inline-block; border: 1px solid #c6f6d5;">
        âœ… è´¦å·ä¸æˆç»©å·²æäº¤åˆ°åå°
      </div>
      <br>
      <button onclick="location.reload()" class="btn-primary btn-large">å†è¯»ä¸€æ¬¡</button>
    </div>

  </div>

  <script>
    // âœ… 1. æ›´æ–°åçš„ GAS é“¾æ¥
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz6Cx8eX2guMerkXB-foaiHWeTn6qVCInPL6_HS6WFVl6Q_NZ2ijNAhMsonOsMBUiod3w/exec";
    
    // è¯¾æ–‡å†…å®¹ï¼šçƒ­é—¹çš„ä¹å›­
    const sentences = [
      "è¯¾é—´ä¼‘æ¯æ—¶ï¼Œæ ¡å›­åƒä¸€åº§ä¹å›­ã€‚",
      "æ´»æ³¼çš„åŒå­¦å‘æ“åœºå¥”å»ã€‚",
      "å¤§å®¶å¼€å¿ƒåœ°æ¸¸æˆï¼Œè¹¦è¹¦è·³è·³ï¼Œæ”¾å£°å¤§ç¬‘ï¼Œå¤šä¹ˆå¿«æ´»ï¼",
      "å¤§æ ‘ä¸‹ï¼ŒåŒå­¦å½å½å–³å–³åœ°è¯´ä¸ªä¸åœã€‚",
      "ä»–ä»¬ç‰µç€æ‰‹ï¼Œè¯´æ‚„æ‚„è¯ï¼Œè¯´ç¬‘è¯ï¼Œä¸æ—¶ç¬‘æˆä¸€å›¢ï¼Œå¤šä¹ˆå¿«ä¹ï¼",
      "å˜»å˜»å“ˆå“ˆçš„ç¬‘å£°ï¼Œåƒä¸€æ³¢åˆä¸€æ³¢çš„æµ·æµªï¼Œæ‹æ‰“ç€æ ¡å›­çš„å„ä¸ªè§’è½ã€‚",
      "å•Šï¼è¿™æ˜¯ä¸€åº§çƒ­é—¹çš„ä¹å›­ã€‚"
    ];
    
    let currentClass = "";
    let googleUser = null; 
    let index = 0;
    let auto = false;
    let autoTimer = null;

    // Google ç™»å½•å›è°ƒ
    function handleCredentialResponse(response) {
      const responsePayload = decodeJwtResponse(response.credential);
      console.log("ID: " + responsePayload.sub);
      
      googleUser = {
        name: responsePayload.name,
        email: responsePayload.email,
        picture: responsePayload.picture
      };

      document.getElementById('googleBtnContainer').style.display = 'none';
      const userCard = document.getElementById('userInfo');
      userCard.style.display = 'inline-flex';
      document.getElementById('userImg').src = googleUser.picture;
      document.getElementById('userNameDisplay').textContent = googleUser.name;

      checkStartEnable();
    }

    // JWT è§£ç 
    function decodeJwtResponse(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function checkStartEnable() {
      const btn = document.getElementById('startAppBtn');
      if(document.getElementById('classSelect').value && googleUser) {
        btn.disabled = false;
        btn.textContent = "å¼€å§‹åšåŠŸè¯¾ ğŸš€";
      }
    }

    document.getElementById('classSelect').addEventListener('change', (e) => {
      currentClass = e.target.value;
      checkStartEnable();
    });

    document.getElementById('startAppBtn').addEventListener('click', () => {
      document.getElementById('loginView').classList.remove('active');
      const rv = document.getElementById('readingView');
      rv.classList.add('active');
      
      // æ›´æ–°ä¾§è¾¹æ ä¿¡æ¯
      document.getElementById('metaClass').textContent = currentClass;
      document.getElementById('metaName').textContent = googleUser.name;

      loadSentence(0);
    });

    // æœ—è¯»é€»è¾‘
    const sentenceText = document.getElementById('sentenceText');
    function loadSentence(i) {
      if(i >= sentences.length) { finishHomework(); return; }
      if(i < 0) return; // é˜²æ­¢è¶Šç•Œ
      index = i;
      sentenceText.innerHTML = sentences[index].split('').map((ch,idx)=>`<span class="ch" data-i="${idx}">${ch}</span>`).join('');
      document.getElementById('footerInfo').textContent = `${index+1} / ${sentences.length}`;
    }

    function playCurrent() {
      window.speechSynthesis.cancel();
      document.querySelectorAll('.ch').forEach(el=>el.style.color='');
      
      const msg = new SpeechSynthesisUtterance(sentences[index]);
      msg.lang = 'zh-CN'; 
      msg.rate = 0.85; 
      
      msg.onboundary = (e) => { 
        if(e.name==='word'||typeof e.charIndex==='number') highlight(e.charIndex); 
      };
      
      msg.onend = () => { 
        if(auto) autoTimer = setTimeout(()=>loadSentence(index+1)||playCurrent(), 2000); 
      };
      
      window.speechSynthesis.speak(msg);
    }
    
    function highlight(i) {
      document.querySelectorAll('.ch').forEach(el=>el.style.color='');
      const span = document.querySelector(`.ch[data-i="${i}"]`);
      if(span) span.style.color='#ff4fa3';
    }

    // æäº¤æ•°æ®
    function finishHomework() {
      auto = false; clearTimeout(autoTimer); window.speechSynthesis.cancel();
      
      const formData = new URLSearchParams();
      formData.append('name', googleUser.name);
      formData.append('email', googleUser.email);
      formData.append('class', currentClass);
      
      // âœ… 2. å¿…é¡»æ·»åŠ â€œç»ƒä¹ åç§°â€ï¼Œå¦åˆ™åå°ä¸çŸ¥é“å†™åˆ°å“ªä¸ªTab
      formData.append('exercise', 'è¯¾æ–‡æœ—è¯»-çƒ­é—¹çš„ä¹å›­'); 

      formData.append('score', "å®Œæˆ");
      formData.append('total', sentences.length);

      fetch(GAS_URL, {
        method: 'POST', mode: 'no-cors',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: formData
      });

      document.getElementById('readingView').classList.remove('active');
      const sv = document.getElementById('successView');
      sv.classList.add('active');
    }

    document.getElementById('playBtn').onclick = playCurrent;
    document.getElementById('nextBtn').onclick = ()=>{ window.speechSynthesis.cancel(); loadSentence(index+1); };
    document.getElementById('prevBtn').onclick = ()=>{ window.speechSynthesis.cancel(); loadSentence(index-1); };
    document.getElementById('autoBtn').onclick = function() {
      auto = !auto; this.textContent = auto?"è‡ªåŠ¨æ’­æ”¾ï¼šå¼€":"è‡ªåŠ¨æ’­æ”¾ï¼šå…³";
      if(auto) playCurrent(); else window.speechSynthesis.cancel();
    };
  </script>
</body>
</html>
